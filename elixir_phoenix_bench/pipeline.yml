jobs:
- name: unit-test
  serial: true
  plan:
  - get: src-phx-bench
    trigger: true
  - task: unit-test
    file: src-phx-bench/elixir_phoenix_bench/tasks/unit-test.yml
- name: integration-test
  plan:
  - get: src-phx-bench
    passed: [unit-test]
    trigger: true
  - task: integration-test
    file: src-phx-bench/elixir_phoenix_bench/tasks/integration-test.yml
- name: release-build
  plan:
  - get: src-phx-bench
    passed: [integration-test]
    trigger: true
  - task: rel-build
    file: src-phx-bench/elixir_phoenix_bench/tasks/build.yml
  - put: publish
    resource: phx-bench-docker-image
    get_params: {skip_download: true}
    params:
      build: rel-artifacts

resources:
- name: src-phx-bench
  type: git
  source:
    uri: https://github.com/cackharot/benchmarks.git
    branch: master
    paths: [elixir_phoenix_bench]

- name: phx-bench-docker-image
  type: docker-image
  source:
    repository: 13.127.47.6:30400/testing/phx_bench
    tag: debug
    insecure_registries:
      - "13.127.47.6:30400"
